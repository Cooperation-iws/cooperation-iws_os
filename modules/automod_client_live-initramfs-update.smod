#!/bin/sh

RMOD_ENGINE=1.0
RMOD_CATEGORY='Software'
RMOD_SUBCATEGORY='Client'
RMOD_NAME='update live-initramfs'
RMOD_AUTHOR='Oliv'
RMOD_VERSION=0.2
RMOD_DESCRIPTION='Office tools for client'
RMOD_RUN_IN_CHROOT=True
RMOD_UPDATE_URL='http://cooperation-iws.gensys-net.eu/update/modules/'
URL_FREE=$(cat /tmp/url_mirroir)

echo "I: updating live-initramfs to live-initramfs from dev"

apt-get remove --assume-yes --force-yes live-initramfs

cd /tmp

wget $URL_FREE/live-initramfs_1.154.8+20090130.001702_all.deb
dpkg -i live-initramfs_1.154.8+20090130.001702_all.deb
apt-get install -f --assume-yes --force-yes 

chmod 755 /usr/share/live-initramfs/languagelist

#sed -i "23G" /usr/share/initramfs-tools/scripts/live
#sed -i '23s/^/cat \/proc\/cmdline > \/cmdline/'  /usr/share/initramfs-tools/scripts/live
#sed -i '24s/^/sed -i "s\/bootkbd\/keyb\/" \/cmdline/'  /usr/share/initramfs-tools/scripts/live
#sed -i '50s/\/proc//' /usr/share/initramfs-tools/scripts/live

echo "
copy_exec /bin/loadkeys /bin
mkdir \${DESTDIR}/usr/share ; cp -r /usr/share/keymaps \${DESTDIR}/usr/share/." >> /usr/share/initramfs-tools/hooks/live 

echo "
modprobe -q loop max_loop=255" >> /usr/share/initramfs-tools/scripts/live-premount/modules


sed -i "3s/user/$(cat /tmp/user)/" /etc/live.conf

sed -i "s/USERNAME=\"user\"/USERNAME=\"$(cat /tmp/user)\"/"  /usr/share/initramfs-tools/scripts/live

sed -i "s/USERFULLNAME=\"Debian Live user\"/USERFULLNAME=\"$(cat /tmp/user_full_name)\"/" /etc/live.conf

sed -i "s/USERFULLNAME=\"Live user\"/USERFULLNAME=\"$(cat /tmp/user_full_name)\"/" /usr/share/initramfs-tools/scripts/live

sed -i "s/HOSTNAME=\"debian\"/HOSTNAME=\"$(cat /tmp/hostname)\"/" /etc/live.conf

sed -i "s/HOSTNAME=\"host\"/HOSTNAME=\"$(cat /tmp/hostname)\"/" /usr/share/initramfs-tools/scripts/live

sed -i "s/8Ab05sVQ4LLps/$(cat /tmp/crypt_user_pass)/" /usr/share/initramfs-tools/scripts/live-bottom/10adduser

sed -i "s/ NOPASSWD://" /usr/share/initramfs-tools/scripts/live-bottom/10adduser

if [ -e /tmp/disable_autologin ]; then

sed -i "s/true/false/g" /usr/share/initramfs-tools/scripts/live-bottom/15autologin 

sed -i "60s/^/#/" /usr/share/initramfs-tools/scripts/live-bottom/15autologin 
sed -i "61s/^/#/" /usr/share/initramfs-tools/scripts/live-bottom/15autologin 
sed -i "63s/^/#/" /usr/share/initramfs-tools/scripts/live-bottom/15autologin 
sed -i "64s/^/#/" /usr/share/initramfs-tools/scripts/live-bottom/15autologin 
sed -i "65s/^/#/" /usr/share/initramfs-tools/scripts/live-bottom/15autologin 
sed -i "66s/^/#/" /usr/share/initramfs-tools/scripts/live-bottom/15autologin 
sed -i "67s/^/#/" /usr/share/initramfs-tools/scripts/live-bottom/15autologin 
sed -i "69s/elif/if/" /usr/share/initramfs-tools/scripts/live-bottom/15autologin  

fi

if [ -e /tmp/encryption ]; then

apt-get install --assume-yes --force-yes aespipe
sed -i '231s/root/$(basename ${fspath})/' /usr/share/initramfs-tools/scripts/live-helpers
sed -i '231s/Enter/\\n Enter/' /usr/share/initramfs-tools/scripts/live-helpers
sed -i '236s/\/sbin\/losetup/\/$root\/sbin\/losetup/' /usr/share/initramfs-tools/scripts/live-helpers
sed -i '230s/^/echo $(basename ${fspath}) | grep -q "home-sn" || echo $(basename ${fspath}) | grep -q "ciws-sn" \&\& root="root"  /' /usr/share/initramfs-tools/scripts/live-helpers
sed -i '959s/do_snap_copy "${dev}" "${snap_mount}" "${snap_type}"/mount -o rw,noatime "${dev}" "${rootmnt}\/home"/' /usr/share/initramfs-tools/scripts/live
sed -i '345s/ro/rw/' /usr/share/initramfs-tools/scripts/live-helpers
sed -i '1364s/ro/rw/' /usr/share/initramfs-tools/scripts/live
sed -i '902s/${snapback}/${mountpoint}/' /usr/share/initramfs-tools/scripts/live

fi


