#!/bin/bash
RMOD_ENGINE=1.0
RMOD_CATEGORY='Software'
RMOD_SUBCATEGORY='Servers'
RMOD_NAME='Joomla 1.5.6'
RMOD_AUTHOR='Oliv'
RMOD_VERSION=0.1
RMOD_DESCRIPTION='Content Management System portal'
RMOD_DESCRIPTION='Portail de gestion de contenu'
RMOD_VERBOSE="Joomla! is an award-winning Content Management System (CMS) that will help you build websites and other powerful online applications. Best of all, Joomla! is an open source solution that is freely available to everybody.  "
RMOD_VERBOSE_FR="http://www.joomla.org/ est un système de gestion de contenu (en anglais, CMS, pour Content Management system) créé par une équipe internationale de développeurs récompensée à maintes reprises, celle-là même qui a hissé Mambo vers les sommets. Et un CMS, c'est quoi?? Pour faire simple, un CMS est un logiciel web qui vous permettra de créer un site internet dynamique en toute simplicité. Joomla! est un CMS Open Source distribué sous license GNU/GPL (gratuit) avec lequel vous pourrez mettre en ligne du contenu et mettre à disposition de vos visiteurs des services (forum, boutique en ligne, galerie photos,…), le tout sans connaissance technique particulière. "

RMOD_RUN_IN_CHROOT=True
RMOD_UPDATE_URL='http://cooperation-iws.gensys-net.eu/update/modules/'
RMOD_REQ_APACHE=True

WWW_DIRECTORY=$(cat /tmp/web-path)
DL_DIR=$(cat /tmp/web_install-path)
BIN_MYSQL=$(cat /tmp/mysql-path)
SCRIPT_DIRECTORY=$(cat /tmp/script-path)
DISPLAY=127.0.0.1:5.0
LAMPP_DIRECTORY=$(cat /tmp/lampp-dir)
LANG_UI=$(cat /tmp/lang-wui)

#TEMP
MIRROIR=$(cat /tmp/mirroir)
URL_FREE=$(cat /tmp/url_mirroir)

INSTALL=$(cat /tmp/def_install)


#VARIABLES
#MYSQL PASSWORD
JOOMLA_MYSQL_PWD="JOOMLA_MYSQL_PWD"

#_______________________________________________________________________________________________
#__________________________________________LANGFR______________________________________________


function LANGFR

{
MESS_NAME="Entrez le nom de l'installation "
MESS_HOW_MANY="Combien de" 
MESS_DO_YOU_WANT="voulez vous installez ?"
}
#_______________________________________________________________________________________________
#__________________________________________FIN_LANGFR___________________________________________

#_______________________________________________________________________________________________
#__________________________________________LANGEN______________________________________________


function LANGEN

{
MESS_NAME="Enter the name of the install "
MESS_HOW_MANY="How many"
MESS_DO_YOU_WANT="do you want to install ?"
}
#_______________________________________________________________________________________________
#__________________________________________FIN_LANGEN___________________________________________


#_______________________________________________________________________________________________
#__________________________________________CHOICE_LANG___________________________________________

function CHOICE_LANG
{
if [ "$(echo "${LANG_UI}" | awk  '{print $1}')" == "FR" ]; then
LANGFR

else
LANGEN

fi
}
#_______________________________________________________________________________________________
#__________________________________________FIN_CHOICE_LANG______________________________________




#_______________________________________________________________________________________________
#________________________________________WGET_MIRROIR_WEB_______________________________________


function WGET_MIRROIR_WEB
{
cd $DL_DIR
wget http://joomlacode.org/gf/download/frsrelease/8232/30034/Joomla_1.5.6-Stable-Full_Package.zip
mkdir Joomla
cp Joomla_1.5.6-Stable-Full_Package.zip Joomla
cd Joomla
unzip -q Joomla_1.5.6-Stable-Full_Package.zip

}

#_______________________________________________________________________________________________
#________________________________________FIN_WGET_MIRROIR_WEB___________________________________

#_______________________________________________________________________________________________
#________________________________________WGET_MIRROIR_LOCAL_____________________________________

function WGET_MIRROIR_LOCAL
{

cd $DL_DIR
wget http://$MIRROIR_URL/mirroir/gallery-2.2.4-full.zip
unzip gallery-2.2.4-full.zip
#rm gallery-2.2.4-full.zip
}

#_______________________________________________________________________________________________
#________________________________________FIN_WGET_MIRROIR_LOCAL_________________________________

#_______________________________________________________________________________________________
#________________________________________WGET_MIRROIR_FREE______________________________________

function WGET_MIRROIR_FREE
{
cd $DL_DIR
wget $URL_FREE/Joomla_1.5.6-Stable-Full_Package.zip
mkdir Joomla
cp Joomla_1.5.6-Stable-Full_Package.zip Joomla
cd Joomla
unzip -q Joomla_1.5.6-Stable-Full_Package.zip
}

#_______________________________________________________________________________________________
#________________________________________FIN_WGET_MIRROIR_FREE__________________________________

#_______________________________________________________________________________________________
#________________________________________DOWNLOAD_______________________________________________

function DOWNLOAD
{
if [ "$(echo "${MIRROIR}" | awk  '{print $1}')" == "A" ]; then 

WGET_MIRROIR_WEB
fi
if  [ "$(echo "${MIRROIR}" | awk  '{print $1}')" == "B" ]; then

WGET_MIRROIR_FREE
fi
if  [ "$(echo "${MIRROIR}" | awk  '{print $1}')" == "C" ]; then


WGET_MIRROIR_LOCAL
fi

}


#_______________________________________________________________________________________________
#________________________________________FIN_DOWNLOAD___________________________________________

#_______________________________________________________________________________________________
#________________________________________CHOOSE_PARAMETERS_GUI______________________________________

function CHOOSE_PARAMETERS_GUI
{
if [ "$(echo "${INSTALL}" | awk  '{print $1}')" == "A" ]; then 
NB_JOOMLA=1
MOD_NAME[1]="Joomla"
else 
NB_JOOMLA=$(zenity --entry --text "$MESS_HOW_MANY Joomla $MESS_DO_YOU_WANT")
test $? -ne 0 && break # Bouton Annuler
while (echo $NB_JOOMLA | grep "[^0-9]") 
do
NB_JOOMLA=$(zenity --entry --text "$MESS_HOW_MANY Joomla $MESS_DO_YOU_WANT")
test $? -ne 0 && break # Bouton Annulerdone
done 

for (( count=1; count<=$NB_JOOMLA; count++ ))
do
MOD_NAME[$count]=$(zenity --entry --text "$MESS_NAME $count JOOMLA")
test $? -ne 0 && break # Bouton Annuler

while (echo ${NOM_ZENPHOTO[$count]} | grep "[^a-zA-Z0-9]") 
do
MOD_NAME[$count]=$(zenity --entry --text "$MESS_NAME $count JOOMLA")
test $? -ne 0 && break # Bouton Annulerdone
done 
done 


fi
export NB_JOOMLA=$NB_JOOMLA
export MOD_NAME=$MOD_NAME

}
#_______________________________________________________________________________________________
#________________________________________FIN_CHOOSE_PARAMETERS_GUI______________________________


#_______________________________________________________________________________________________
#________________________________________INSTALL________________________________________________


function INSTALL
{
echo "I: Download Joomla"

DOWNLOAD

#Joomla

for (( count=1; count<=$NB_JOOMLA; count++ ))
do
cd $DL_DIR
mkdir $WWW_DIRECTORY/${MOD_NAME[$count]}
cp -Rf Joomla/* $WWW_DIRECTORY/${MOD_NAME[$count]}/.
echo "create database ${MOD_NAME[$count]};
grant all on ${MOD_NAME[$count]}.* to ${MOD_NAME[$count]}@localhost identified by '$JOOMLA_MYSQL_PWD';
flush privileges;" > joomla_db.sql

$BIN_MYSQL -u root < joomla_db.sql mysql
rm joomla_db.sql

sed -i "154s/{VAR_DBHOSTNAME}/localhost/" $WWW_DIRECTORY/${MOD_NAME[$count]}/installation/template/tmpl/dbconfig.html
sed -i "168s/{VAR_DBUSERNAME}/${MOD_NAME[$count]}/" $WWW_DIRECTORY/${MOD_NAME[$count]}/installation/template/tmpl/dbconfig.html
sed -i "182s/{VAR_DBPASSWORD}/$JOOMLA_MYSQL_PWD/" $WWW_DIRECTORY/${MOD_NAME[$count]}/installation/template/tmpl/dbconfig.html
sed -i "196s/{VAR_DBNAME}/${MOD_NAME[$count]}/" $WWW_DIRECTORY/${MOD_NAME[$count]}/installation/template/tmpl/dbconfig.html


chown -R www-data $WWW_DIRECTORY/${MOD_NAME[$count]}

done
}

#_______________________________________________________________________________________________
#________________________________________FIN_INSTALL____________________________________________

#_______________________________________________________________________________________________
#________________________________________CREATE_WUI_____________________________________________

function CREATE_WUI
{
for (( count=1; count<=$NB_JOOMLA; count++ ))

do
echo "
<item>
	<item_category>$RMOD_DESCRIPTION</item_category>
	<item_url>/${MOD_NAME[$count]}</item_url>
	<item_name>$RMOD_NAME</item_name>
	<item_desc>$RMOD_VERBOSE</item_desc>
	<item_admin_url>/${MOD_NAME[$count]}/administrator/</item_admin_url>
</item>
" >> $WWW_DIRECTORY/cooperation-wui.xml
echo "
<item>
	<item_category>$RMOD_DESCRIPTION_FR</item_category>
	<item_url>/${MOD_NAME[$count]}</item_url>
	<item_name>$RMOD_NAME</item_name>
	<item_desc>$RMOD_VERBOSE_FR</item_desc>
	<item_admin_url>/${MOD_NAME[$count]}/administrator/</item_admin_url>
</item>
" >> $WWW_DIRECTORY/cooperation-wui-fr.xml

done

}
#_______________________________________________________________________________________________
#________________________________________FIN_CREATE_WUI_________________________________________

#_______________________________________________________________________________________________
#________________________________________CREATE_INSTALL_SCRIPT__________________________________


function CREATE_INSTALL_SCRIPT
{

for (( count=1; count<=$NB_JOOMLA; count++ ))

do
echo "
#Joomla
sed -i \"11s/http:\/\/localhost//\" $WWW_DIRECTORY/${MOD_NAME[$count]}/configuration.php
rm -r $WWW_DIRECTORY/${MOD_NAME[$count]}/installation
" >> $LAMPP_DIRECTORY/share/lampp/config_post_install.sh
done

}

#_______________________________________________________________________________________________
#________________________________________FIN_CREATE_INSTALL_SCRIPT______________________________

echo "I: Install Joomla"
CHOICE_LANG
CHOOSE_PARAMETERS_GUI
INSTALL
CREATE_WUI
CREATE_INSTALL_SCRIPT
echo "I: End of install Joomla"
