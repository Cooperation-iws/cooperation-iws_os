#!/bin/bash

RMOD_ENGINE=1.0
RMOD_CATEGORY='Software'
RMOD_SUBCATEGORY='Servers'
RMOD_NAME='Zenphoto1.2'
RMOD_AUTHOR='Oliv'
RMOD_VERSION=0.1
RMOD_DESCRIPTION='Pictures gallery'
RMOD_DESCRIPTION_FR="Galleries d'images"
RMOD_VERBOSE="Zenphoto is an answer to lots of calls for an online gallery solution that just makes sense. After years of bloated software that does everything and your dishes, zenphoto just shows your photos, simply. It’s got all the functionality and “features” you need, and nothing you don’t. Where the old guys put in a bunch of modules and junk, we put a lot of thought. We hope you agree with our philosopy: simpler is better. Don’t get us wrong though –zenphoto really does have everything you need for your online gallery, and you’ll even stare in awe at some of the innovative innovations we innovated upon.   "
RMOD_VERBOSE_FR="Zenphoto est un petit logiciel de gestion de collection d'images."


RMOD_RUN_IN_CHROOT=True
RMOD_UPDATE_URL='http://cooperation-iws.gensys-net.eu/update/modules/'
RMOD_REQ_APACHE=True

WWW_DIRECTORY=$(cat /tmp/web-path)
DL_DIR=$(cat /tmp/web_install-path)
BIN_MYSQL=$(cat /tmp/mysql-path)
SCRIPT_DIRECTORY=$(cat /tmp/script-path)
LAMPP_DIRECTORY=$(cat /tmp/lampp-dir)
DISPLAY=127.0.0.1:5.0 
LANG_UI=$(cat /tmp/lang-wui)


#TEMP
MIRROIR=$(cat /tmp/mirroir)
URL_FREE=$(cat /tmp/url_mirroir)
INSTALL=$(cat /tmp/def_install)

ZENPHOTO_MYSQL_PWD="ZENPHOTO_MYSQL_PWD"


#_______________________________________________________________________________________________
#__________________________________________LANGFR______________________________________________


function LANGFR

{
MESS_NAME="Entrez le nom de l'installation "
MESS_HOW_MANY="Combien de" 
MESS_DO_YOU_WANT="voulez vous installez ?"
}
#_______________________________________________________________________________________________
#__________________________________________FIN_LANGFR___________________________________________

#_______________________________________________________________________________________________
#__________________________________________LANGEN______________________________________________


function LANGEN

{
MESS_NAME="Enter the name of the install "
MESS_HOW_MANY="How many"
MESS_DO_YOU_WANT="do you want to install ?"
}
#_______________________________________________________________________________________________
#__________________________________________FIN_LANGEN___________________________________________


#_______________________________________________________________________________________________
#__________________________________________CHOICE_LANG___________________________________________

function CHOICE_LANG
{
if [ "$(echo "${LANG_UI}" | awk  '{print $1}')" == "FR" ]; then
LANGFR

else
LANGEN

fi
}
#_______________________________________________________________________________________________
#__________________________________________FIN_CHOICE_LANG______________________________________



#_______________________________________________________________________________________________
#________________________________________WGET_MIRROIR_WEB_______________________________________


function WGET_MIRROIR_WEB
{
cd $DL_DIR
wget http://www.zenphoto.org/files/zenphoto-1.2.zip
unzip -q zenphoto-1.2.zip
#rm zenphoto-1.1.5.zip

}

#_______________________________________________________________________________________________
#________________________________________FIN_WGET_MIRROIR_WEB___________________________________

#_______________________________________________________________________________________________
#________________________________________WGET_MIRROIR_LOCAL_____________________________________

function WGET_MIRROIR_LOCAL
{

cd $DL_DIR
wget http://$MIRROIR_URL/mirroir/zenphoto-1.1.5.zip
unzip zenphoto-1.1.5.zip
#rm zenphoto-1.1.5.zip
}

#_______________________________________________________________________________________________
#________________________________________FIN_WGET_MIRROIR_LOCAL_________________________________

#_______________________________________________________________________________________________
#________________________________________WGET_MIRROIR_FREE______________________________________

function WGET_MIRROIR_FREE
{
cd $DL_DIR
wget $URL_FREE/zenphoto-1.2.zip
unzip -q zenphoto-1.2.zip
#rm zenphoto-1.1.5.zip

}

#_______________________________________________________________________________________________
#________________________________________FIN_WGET_MIRROIR_FREE__________________________________

#_______________________________________________________________________________________________
#________________________________________DOWNLOAD_______________________________________________

function DOWNLOAD
{
if [ "$(echo "${MIRROIR}" | awk  '{print $1}')" == "A" ]; then 

WGET_MIRROIR_WEB
fi
if  [ "$(echo "${MIRROIR}" | awk  '{print $1}')" == "B" ]; then

WGET_MIRROIR_FREE
fi
if  [ "$(echo "${MIRROIR}" | awk  '{print $1}')" == "C" ]; then


WGET_MIRROIR_LOCAL
fi

}


#_______________________________________________________________________________________________
#________________________________________FIN_DOWNLOAD___________________________________________

#_______________________________________________________________________________________________
#________________________________________CHOOSE_PARAMETERS_GUI______________________________________

function CHOOSE_PARAMETERS_GUI
{
if [ "$(echo "${INSTALL}" | awk  '{print $1}')" == "A" ]; then 
NB_ZENPHOTO=1
MOD_NAME[1]="Zenphoto"

else 

NB_ZENPHOTO=$(zenity --entry --text "$MESS_HOW_MANY Zenphoto $MESS_DO_YOU_WANT")
test $? -ne 0 && break # Bouton Annuler
while (echo $NB_ZENPHOTO | grep "[^0-9]") 
do
NB_ZENPHOTO=$(zenity --entry --text "$MESS_HOW_MANY Zenphoto $MESS_DO_YOU_WANT")
test $? -ne 0 && break # Bouton Annulerdone
done 

for (( count=1; count<=$NB_ZENPHOTO; count++ ))
do
MOD_NAME[$count]=$(zenity --entry --text "$MESS_NAME $count ZENPHOTO")
test $? -ne 0 && break # Bouton Annuler

while (echo ${MOD_NAME[$count]} | grep "[^a-zA-Z0-9]") 
do
MOD_NAME[$count]=$(zenity --entry --text "$MESS_NAME $count ZENPHOTO")
test $? -ne 0 && break # Bouton Annulerdone
done 
done 


fi
export NB_ZENPHOTO=$NB_ZENPHOTO
export MOD_NAME=$MOD_NAME

}
#_______________________________________________________________________________________________
#________________________________________FIN_CHOOSE_PARAMETERS_GUI______________________________


#_______________________________________________________________________________________________
#________________________________________INSTALL________________________________________________


function INSTALL
{
echo "I: Download Zenphoto"
DOWNLOAD

for (( count=1; count<=$NB_ZENPHOTO; count++ ))
do
cd $DL_DIR
mkdir $WWW_DIRECTORY/${MOD_NAME[$count]}
cp -Rf zenphoto/* $WWW_DIRECTORY/${MOD_NAME[$count]}/.
#mv $WWW_DIRECTORY/${MOD_NAME[$count]}/zp-core/zp-config.php.example $WWW_DIRECTORY/${MOD_NAME[$count]}/zp-core/zp-config.php
echo "create database ${MOD_NAME[$count]};
grant all on ${MOD_NAME[$count]}.* to ${MOD_NAME[$count]}@localhost identified by '$ZENPHOTO_MYSQL_PWD';
flush privileges;" > zenphoto_db.sql

$BIN_MYSQL -u root < zenphoto_db.sql mysql
rm zenphoto_db.sql
sed -i -e "28s/\"\"/\"${MOD_NAME[$count]}\"/" $WWW_DIRECTORY/${MOD_NAME[$count]}/zp-core/zp-config.php.source
sed -i -e "29s/\"\"/\"$ZENPHOTO_MYSQL_PWD\"/" $WWW_DIRECTORY/${MOD_NAME[$count]}/zp-core/zp-config.php.source
sed -i -e "31s/\"\"/\"${MOD_NAME[$count]}\"/" $WWW_DIRECTORY/${MOD_NAME[$count]}/zp-core/zp-config.php.source

chown -R www-data $WWW_DIRECTORY/${MOD_NAME[$count]}

done

}

#_______________________________________________________________________________________________
#________________________________________FIN_INSTALL____________________________________________

#_______________________________________________________________________________________________
#________________________________________CREATE_WUI_____________________________________________

function CREATE_WUI
{
for (( count=1; count<=$NB_ZENPHOTO; count++ ))

do
echo "
<item>
	<item_category>$RMOD_DESCRIPTION</item_category>
	<item_url>/${MOD_NAME[$count]}</item_url>
	<item_name>$RMOD_NAME</item_name>
	<item_desc>$RMOD_VERBOSE</item_desc>
	<item_admin_url>/${MOD_NAME[$count]}</item_admin_url>
</item>
" >> $WWW_DIRECTORY/cooperation-wui.xml
echo "
<item>
	<item_category>$RMOD_DESCRIPTION_FR</item_category>
	<item_url>/${MOD_NAME[$count]}</item_url>
	<item_name>$RMOD_NAME</item_name>
	<item_desc>$RMOD_VERBOSE_FR</item_desc>
	<item_admin_url>/${MOD_NAME[$count]}</item_admin_url>
</item>
" >> $WWW_DIRECTORY/cooperation-wui-fr.xml

done

}
#_______________________________________________________________________________________________
#________________________________________FIN_CREATE_WUI_________________________________________


#_______________________________________________________________________________________________
#________________________________________FIN_CREATE_INSTALL_SCRIPT______________________________


echo "I: Install Zenphoto"
CHOICE_LANG

CHOOSE_PARAMETERS_GUI
INSTALL
CREATE_WUI
echo "I: End of install Zenphoto"
