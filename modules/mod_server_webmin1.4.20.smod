#!/bin/bash


RMOD_ENGINE=1.0
RMOD_CATEGORY='Software'
RMOD_SUBCATEGORY='Server'
RMOD_NAME='Webmin 1.4.20'
RMOD_AUTHOR='Oliv'
RMOD_VERSION=0.2
RMOD_DESCRIPTION='Web based unix management'
RMOD_DESCRIPTION_FR='Gestion du système unix en ligne'
RMOD_VERBOSE_FR="Webmin est un front-end web d'administration de système Unix. "
RMOD_VERBOSE="Webmin is a web-based interface for system administration for Unix. Using any modern web browser, you can setup user accounts, Apache, DNS, file sharing and much more. Webmin removes the need to manually edit Unix configuration files like /etc/passwd, and lets you manage a system from the console or remotely."

RMOD_RUN_IN_CHROOT=True
RMOD_UPDATE_URL='http://cooperation-iws.gensys-net.eu/update/modules/'


WWW_DIRECTORY=$(cat /tmp/web-path)
DL_DIR=$(cat /tmp/web_install-path)
BIN_MYSQL=$(cat /tmp/mysql-path)
LAMPP_DIRECTORY=$WWW_DIRECTORY
DISPLAY=127.0.0.1:5.0
LANG_UI=$(cat /tmp/lang-wui)

SILENT=$(cat /tmp/silent)
if [ "$(echo $SILENT | awk  '{print $1}')" != "" ]; then
. /tmp/app_params
fi


#TEMP
MIRROIR=$(cat /tmp/mirroir)
URL_FREE=$(cat /tmp/url_mirroir)
INSTALL=$(cat /tmp/def_install)

#VARIABLES

#_______________________________________________________________________________________________
#__________________________________________LANGFR______________________________________________


function LANGFR

{
MESS_NAME="Entrez le nom de l'installation "
MESS_HOW_MANY="Combien de" 
MESS_DO_YOU_WANT="voulez vous installez ?"
MESS_WARNING_PASSWORD="La prochaine boîte de dialogue va vous demander de saisir le mot de passe root de webmin.
Le mot de passe doit faire plus de six caractères."
}
#_______________________________________________________________________________________________
#__________________________________________FIN_LANGFR___________________________________________

#_______________________________________________________________________________________________
#__________________________________________LANGEN______________________________________________


function LANGEN

{
MESS_NAME="Enter the name of the install "
MESS_HOW_MANY="How many"
MESS_DO_YOU_WANT="do you want to install ?"
MESS_WARNING_PASSWORD="The next dialog box will ask you to choose webmin root password.
the password shall at least count 6 characters."
}
#_______________________________________________________________________________________________
#__________________________________________FIN_LANGEN___________________________________________


#_______________________________________________________________________________________________
#__________________________________________CHOICE_LANG___________________________________________

function CHOICE_LANG
{
if [ "$(echo "${LANG_UI}" | awk  '{print $1}')" == "FR" ]; then
LANGFR

else
LANGEN

fi
}
#_______________________________________________________________________________________________
#__________________________________________FIN_CHOICE_LANG______________________________________


#_______________________________________________________________________________________________
#________________________________________WGET_MIRROIR_WEB_______________________________________


function WGET_MIRROIR_WEB
{
echo -e '\E[37;44m'"\033[1m $MESSAGE \033[0m"
wget http://surfnet.dl.sourceforge.net/sourceforge/webadmin/webmin_1.420_all.deb




}

#_______________________________________________________________________________________________
#________________________________________FIN_WGET_MIRROIR_WEB___________________________________

#_______________________________________________________________________________________________
#________________________________________WGET_MIRROIR_LOCAL_____________________________________

function WGET_MIRROIR_LOCAL
{

cd $DL_DIR
wget http://$MIRROIR_URL/mirroir/webmin_1.410_all.deb



}

#_______________________________________________________________________________________________
#________________________________________FIN_WGET_MIRROIR_LOCAL_________________________________

#_______________________________________________________________________________________________
#________________________________________WGET_MIRROIR_FREE______________________________________

function WGET_MIRROIR_FREE
{
cd $DL_DIR
wget $URL_FREE/webmin_1.420_all.deb




}

#_______________________________________________________________________________________________
#________________________________________FIN_WGET_MIRROIR_FREE__________________________________

#_______________________________________________________________________________________________
#________________________________________DOWNLOAD_______________________________________________

function DOWNLOAD
{
if [ "$(echo "${MIRROIR}" | awk  '{print $1}')" == "A" ]; then 

WGET_MIRROIR_WEB
fi
if  [ "$(echo "${MIRROIR}" | awk  '{print $1}')" == "B" ]; then

WGET_MIRROIR_FREE
fi
if  [ "$(echo "${MIRROIR}" | awk  '{print $1}')" == "C" ]; then


WGET_MIRROIR_LOCAL
fi

}


#_______________________________________________________________________________________________
#________________________________________FIN_DOWNLOAD___________________________________________

#_______________________________________________________________________________________________
#________________________________________INSTALL________________________________________________


function INSTALL
{
if [ "$(echo $SILENT | awk  '{print $1}')" != "" ]; then
echo $webmin_pwd > $DOSSIER_CHROOT/tmp/passwd.txt
else
echo "
---------Cooperation-iws----------

$MESS_WARNING_PASSWORD

---------Press Enter--------------
" 
read r < /dev/tty

function CHOIX_PASS() 
{
SAISIE_PASS1="";SAISIE_PASS2="";

function SAISIE()
{
echo  "Enter your root password (1):"
read SAISIE_PASS1 < /dev/tty
sleep 2
echo  "Confirm your root password (2):"
read SAISIE_PASS2 < /dev/tty
}
while [[ "$SAISIE_PASS1" != "$SAISIE_PASS2" || "$(echo -e "$SAISIE_PASS1" | wc -m)" -le "6" ]]
do
SAISIE
if [[ -n "$SAISIE_PASS1" && -n "$SAISIE_PASS2" ]]; then
if  [ $(echo -e "$SAISIE_PASS1" | wc -m) -le 6 ]; then
echo -e "\033[1;47;31m la saisie minimum est de 6 caractères \033[0m" ;
elif [ "$SAISIE_PASS1" != "$SAISIE_PASS2" ]; then
echo -e "\033[1;47;31m Erreur: pass 1 et 2 differents! \033[0m" ;
fi
fi
done
if [[ "$SAISIE_PASS1" == "$SAISIE_PASS2" && "$(echo -e "$SAISIE_PASS1" | wc -m)" -ge "6" ]]; then
echo $SAISIE_PASS2 > $DOSSIER_CHROOT/tmp/passwd.txt

fi
}

CHOIX_PASS


fi
echo "I: Download Webmin"
DOWNLOAD
DEBIAN_FRONTEND="dialog"
apt-get install --assume-yes --force-yes libnet-ssleay-perl libauthen-pam-perl libio-pty-perl libmd5-perl openssl
#WEBMIN CONFIG


echo "
GREP=$(ps aux | grep 'share/webmin')
PID=$(echo $GREP | cut -d' ' -f2)
kill $PID
killall \"/usr/bin/perl /usr/share/webmin/miniserv.pl /etc/webmin/miniserv.conf\"
" >> /tmp/shutdown_ws.sh

cd $DL_DIR

GREP=$(ps aux | grep 'share/webmin')
PID=$(echo $GREP | cut -d' ' -f2)
kill $PID
killall "/usr/bin/perl /usr/share/webmin/miniserv.pl /etc/webmin/miniserv.conf"

dpkg -i webmin_1.420_all.deb

/usr/share/webmin/changepass.pl /etc/webmin root $(cat /tmp/passwd.txt)

mv /etc/webmin /var/share/etc/
mv /usr/share/webmin /var/share/usr/share

ln -s /var/share/etc/webmin /etc/webmin

ln -s /var/share/usr/share/webmin /usr/share/webmin

}

#_______________________________________________________________________________________________
#________________________________________FIN_INSTALL____________________________________________

#_______________________________________________________________________________________________
#________________________________________CREATE_WUI_____________________________________________

function CREATE_WUI
{

echo "
	<item>
	<item_category>$RMOD_DESCRIPTION</item_category>
	<item_url>https://localhost:10000</item_url>
	<item_name>$RMOD_NAME</item_name>
	<item_desc>$RMOD_VERBOSE</item_desc>
	</item>
" >> /tmp/admin_cooperation-wui.xml
echo "
	<item>
	<item_category>$RMOD_DESCRIPTION_FR</item_category>
	<item_url>https://localhost:10000</item_url>
	<item_name>$RMOD_NAME</item_name>
	<item_desc>$RMOD_VERBOSE_FR</item_desc>
	</item>
" >> /tmp/admin_cooperation-wui-fr.xml


}
#_______________________________________________________________________________________________
#________________________________________FIN_CREATE_WUI_________________________________________


echo "I: Install Webmin"
CHOICE_LANG
INSTALL
CREATE_WUI
echo "I: End of install Webmin"
