#!/bin/bash


RMOD_ENGINE=1.0
RMOD_CATEGORY='Software'
RMOD_SUBCATEGORY='Servers'
RMOD_NAME='Mantis1.1.2'
RMOD_AUTHOR='Oliv'
RMOD_VERSION=0.2
RMOD_DESCRIPTION='Bug Tracking system'
RMOD_RUN_IN_CHROOT=True
RMOD_UPDATE_URL='http://cooperation-iws.gensys-net.eu/update/modules/'
RMOD_REQ_APACHE=True

WWW_DIRECTORY=$(cat /tmp/web-path)
DL_DIR=$(cat /tmp/web_install-path)
BIN_MYSQL=$(cat /tmp/mysql-path)
SCRIPT_DIRECTORY=$(cat /tmp/script-path)
DISPLAY=127.0.0.1:5.0
LAMPP_DIRECTORY=$(cat /tmp/lampp-dir)
LANG_UI=$(cat /tmp/lang-wui)


#TEMP
MIRROIR=$(cat /tmp/mirroir)
URL_FREE=$(cat /tmp/url_mirroir)
INSTALL=$(cat /tmp/def_install)
#VARIABLES

MANTIS_MYSQL_PWD="MANTIS_MYSQL_PWD"

#_______________________________________________________________________________________________
#__________________________________________LANGFR______________________________________________


function LANGFR

{
MESS_NAME="Entrez le nom de l'installation "
MESS_HOW_MANY="Combien de" 
MESS_DO_YOU_WANT="voulez vous installez ?"
}
#_______________________________________________________________________________________________
#__________________________________________FIN_LANGFR___________________________________________

#_______________________________________________________________________________________________
#__________________________________________LANGEN______________________________________________


function LANGEN

{
MESS_NAME="Enter the name of the install "
MESS_HOW_MANY="How many"
MESS_DO_YOU_WANT="do you want to install ?"
}
#_______________________________________________________________________________________________
#__________________________________________FIN_LANGEN___________________________________________


#_______________________________________________________________________________________________
#__________________________________________CHOICE_LANG___________________________________________

function CHOICE_LANG
{
if [ "$(echo "${LANG_UI}" | awk  '{print $1}')" == "FR" ]; then
LANGFR

else
LANGEN

fi
}
#_______________________________________________________________________________________________
#__________________________________________FIN_CHOICE_LANG______________________________________



#_______________________________________________________________________________________________
#________________________________________WGET_MIRROIR_WEB_______________________________________


function WGET_MIRROIR_WEB
{
cd $DL_DIR
wget http://heanet.dl.sourceforge.net/sourceforge/mantisbt/mantis-1.1.2.tar.gz
tar -xzf mantis-1.1.2.tar.gz
mv mantis-1.1.2 mantis
}

#_______________________________________________________________________________________________
#________________________________________FIN_WGET_MIRROIR_WEB___________________________________

#_______________________________________________________________________________________________
#________________________________________WGET_MIRROIR_LOCAL_____________________________________

function WGET_MIRROIR_LOCAL
{
cd $DL_DIR
wget http://$MIRROIR_URL/mirroir/mantis-1.1.1.tar.gz
tar -xzvf mantis-1.1.1.tar.gz
mv mantis-1.1.1 mantis
}
#_______________________________________________________________________________________________
#________________________________________FIN_WGET_MIRROIR_LOCAL_________________________________

#_______________________________________________________________________________________________
#________________________________________WGET_MIRROIR_FREE______________________________________

function WGET_MIRROIR_FREE
{
cd $DL_DIR
wget $URL_FREE/mantis-1.1.2.tar.gz
tar -xzf mantis-1.1.2.tar.gz
mv mantis-1.1.2 mantis
}

#_______________________________________________________________________________________________
#________________________________________FIN_WGET_MIRROIR_FREE__________________________________

#_______________________________________________________________________________________________
#________________________________________DOWNLOAD_______________________________________________

function DOWNLOAD
{
if [ "$(echo "${MIRROIR}" | awk  '{print $1}')" == "A" ]; then 

WGET_MIRROIR_WEB
fi
if  [ "$(echo "${MIRROIR}" | awk  '{print $1}')" == "B" ]; then

WGET_MIRROIR_FREE
fi
if  [ "$(echo "${MIRROIR}" | awk  '{print $1}')" == "C" ]; then


WGET_MIRROIR_LOCAL
fi

}


#_______________________________________________________________________________________________
#________________________________________FIN_DOWNLOAD___________________________________________

#_______________________________________________________________________________________________
#________________________________________CHOOSE_PARAMETERS_GUI______________________________________

function CHOOSE_PARAMETERS_GUI
{
if [ "$(echo "${INSTALL}" | awk  '{print $1}')" == "A" ]; then 
NB_MANTIS=1
NOM_MANTIS[1]="Mantis"
else 
NB_MANTIS=$(zenity --entry --text "$MESS_HOW_MANY Mantis $MESS_DO_YOU_WANT")
test $? -ne 0 && break # Bouton Annuler

while (echo $NB_MANTIS | grep "[^0-9]") 
do
NB_MANTIS=$(zenity --entry --text "$MESS_HOW_MANY Mantis $MESS_DO_YOU_WANT")
test $? -ne 0 && break # Bouton Annulerdone
done 

for (( count=1; count<=$NB_MANTIS; count++ ))
do
NOM_MANTIS[$count]=$(zenity --entry --text "$MESS_NAME $count MANTIS")
test $? -ne 0 && break # Bouton Annuler
while (echo ${NOM_MANTIS[$count]} | grep "[^a-zA-Z0-9]") 
do
NOM_MANTIS[$count]=$(zenity --entry --text "$MESS_NAME $count MANTIS")
test $? -ne 0 && break # Bouton Annulerdone
done 

done 



fi

export NB_MANTIS=$NB_MANTIS
export NOM_MANTIS=$NOM_MANTIS
}
#_______________________________________________________________________________________________
#________________________________________FIN_CHOOSE_PARAMETERS_GUI______________________________



#_______________________________________________________________________________________________
#________________________________________INSTALL________________________________________________


function INSTALL
{
echo "I: Download Mantis"
DOWNLOAD

#Mantis

for (( count=1; count<=$NB_MANTIS; count++ ))
do
cd $DL_DIR
echo "create database ${NOM_MANTIS[$count]};
grant all on ${NOM_MANTIS[$count]}.* to ${NOM_MANTIS[$count]}@localhost identified by '$MANTIS_MYSQL_PWD';
flush privileges;" > mantis_db.sql
$BIN_MYSQL -u root < mantis_db.sql mysql
rm mantis_db.sql

mkdir $WWW_DIRECTORY/${NOM_MANTIS[$count]}
cp -Rf mantis/* $WWW_DIRECTORY/${NOM_MANTIS[$count]}/.
cat $WWW_DIRECTORY/${NOM_MANTIS[$count]}/admin/install.php | sed -i -e "91s/ config_get( 'database_name', 'bugtrack') /'${NOM_MANTIS[$count]}'/" $WWW_DIRECTORY/${NOM_MANTIS[$count]}/admin/install.php
cat $WWW_DIRECTORY/${NOM_MANTIS[$count]}/admin/install.php | sed -i -e "97s/''/'${NOM_MANTIS[$count]}'/" $WWW_DIRECTORY/${NOM_MANTIS[$count]}/admin/install.php
cat $WWW_DIRECTORY/${NOM_MANTIS[$count]}/admin/install.php | sed -i -e "92s/config_get( 'db_username', '' )/'${NOM_MANTIS[$count]}'/" $WWW_DIRECTORY/${NOM_MANTIS[$count]}/admin/install.php
cat $WWW_DIRECTORY/${NOM_MANTIS[$count]}/admin/install.php | sed -i -e "93s/config_get( 'db_password', '' )/'$MANTIS_MYSQL_PWD'/" $WWW_DIRECTORY/${NOM_MANTIS[$count]}/admin/install.php
cat $WWW_DIRECTORY/${NOM_MANTIS[$count]}/admin/install.php | sed -i -e "98s/''/'$MANTIS_MYSQL_PWD'/" $WWW_DIRECTORY/${NOM_MANTIS[$count]}/admin/install.php
cat $WWW_DIRECTORY/${NOM_MANTIS[$count]}/admin/install.php | sed -i -e "94s/if/#if/" $WWW_DIRECTORY/${NOM_MANTIS[$count]}/admin/install.php
cat $WWW_DIRECTORY/${NOM_MANTIS[$count]}/admin/install.php | sed -i -e "95s/\$f_db_password/#\$f_db_password/" $WWW_DIRECTORY/${NOM_MANTIS[$count]}/admin/install.php
cat $WWW_DIRECTORY/${NOM_MANTIS[$count]}/admin/install.php | sed -i -e "96s/}/#}/" $WWW_DIRECTORY/${NOM_MANTIS[$count]}/admin/install.php
cat $WWW_DIRECTORY/${NOM_MANTIS[$count]}/admin/install.php | sed -i -e "468s/( !is_blank( \$f_db_password ) ? CONFIGURED_PASSWORD : \"\" )/\$f_db_password/" $WWW_DIRECTORY/${NOM_MANTIS[$count]}/admin/install.php

chown -R www-data $WWW_DIRECTORY/${NOM_MANTIS[$count]}
done
}

#_______________________________________________________________________________________________
#________________________________________FIN_INSTALL____________________________________________

#_______________________________________________________________________________________________
#________________________________________CREATE_WUI_____________________________________________

function CREATE_WUI
{

for (( count=1; count<=$NB_MANTIS; count++ ))

do
echo "$RMOD_DESCRIPTION | <a href=\"/${NOM_MANTIS[$count]}\">${NOM_MANTIS[$count]}</a> | <a href=\"/${NOM_MANTIS[$count]}/admin\">Admin</a><br>
" >> $WWW_DIRECTORY/cooperation-wui.frame.php
done
}
#_______________________________________________________________________________________________
#________________________________________FIN_CREATE_WUI_________________________________________


#_______________________________________________________________________________________________
#________________________________________FIN_CREATE_INSTALL_SCRIPT______________________________

echo "I: Install Mantis"
CHOICE_LANG
CHOOSE_PARAMETERS_GUI
INSTALL
CREATE_WUI
echo "I: End of install Mantis"
