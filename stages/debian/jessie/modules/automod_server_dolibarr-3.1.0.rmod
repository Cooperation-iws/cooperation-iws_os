#!/bin/bash
RMOD_ENGINE=1.0
RMOD_CATEGORY='Software'
RMOD_SUBCATEGORY='Servers'
RMOD_NAME='Dolibarr 3.5'
RMOD_AUTHOR='Oliv'
RMOD_VERSION=0.1
RMOD_DESCRIPTION='ERP for small companies'
RMOD_DESCRIPTION_FR='ERP pour PMI'
RMOD_VERBOSE=""
RMOD_VERBOSE_FR=""


RMOD_RUN_IN_CHROOT=True
RMOD_UPDATE_URL='http://cooperation-iws.gensys-net.eu/update/modules/'
RMOD_REQ_APACHE=True


. /tmp/scripts_params
. /tmp/app_params



DOLIBARR_MYSQL_PWD=${dolibarr_mysql_pwd}
MOD_NAME=${dolibarr_mysql_user}


#_______________________________________________________________________________________________
#________________________________________WGET_CIWS_DEPOT______________________________________

function WGET_CIWS_DEPOT
{
cd $DL_DIR
wget $URL_CIWS_DEPOT/dolibarr-3.5.4-1.sql


}

#_______________________________________________________________________________________________
#________________________________________FIN_WGET_CIWS_DEPOT__________________________________




#_______________________________________________________________________________________________
#________________________________________INSTALL________________________________________________


function INSTALL
{
echo "I: Download Dolibarr"
WGET_CIWS_DEPOT

apt-get install --assume-yes --force-yes zip dolibarr

mv /etc/dolibarr $LAMPP_DIRECTORY/etc
ln -s $LAMPP_DIRECTORY/etc/dolibarr /etc/dolibarr
mv /usr/share/dolibarr $LAMPP_DIRECTORY/usr/share
ln -s $LAMPP_DIRECTORY/usr/share/dolibarr /usr/share/dolibarr

echo "
<?php
//
// File generated by Dolibarr installer 3.5.4 on 19 jan. 2015
//
// Take a look at conf.php.example file for an example of conf.php file
// and explanations for all possibles parameters.
//
\$dolibarr_main_url_root='/dolibarr';
\$dolibarr_main_document_root='/usr/share/dolibarr/htdocs';
//\$dolibarr_main_url_root_alt='/custom';
//\$dolibarr_main_document_root_alt='/usr/share/dolibarr/htdocs/custom';
\$dolibarr_main_data_root='/var/lib/dolibarr/documents';
\$dolibarr_main_db_host='localhost';
\$dolibarr_main_db_port='3306';
\$dolibarr_main_db_name='dolibarr';
\$dolibarr_main_db_prefix='llx_';
\$dolibarr_main_db_user='$MOD_NAME';
\$dolibarr_main_db_pass='$DOLIBARR_MYSQL_PWD';
\$dolibarr_main_db_type='mysqli';
\$dolibarr_main_db_character_set='utf8';
\$dolibarr_main_db_collation='utf8_general_ci';
\$dolibarr_main_authentication='dolibarr';

// Specific settings
\$dolibarr_main_prod='0';
\$dolibarr_nocsrfcheck='0';
\$dolibarr_main_force_https='0';
\$dolibarr_main_cookie_cryptkey='9e5953bdfff59fa71200596cd94896fc';
\$dolibarr_mailing_limit_sendbyweb='0';

\$dolibarr_lib_TCPDF_PATH='/usr/share/php/tcpdf';
//\$dolibarr_lib_FPDF_PATH='';
\$dolibarr_lib_FPDI_PATH='/usr/share/php/fpdi';
\$dolibarr_lib_ADODB_PATH='/usr/share/php/adodb';
//\$dolibarr_lib_GEOIP_PATH='';
\$dolibarr_lib_NUSOAP_PATH='/usr/share/php/nusoap';
\$dolibarr_lib_PHPEXCEL_PATH='disabled';
//\$dolibarr_lib_ODTPHP_PATH='';
\$dolibarr_lib_ODTPHP_PATHTOPCLZIP='/usr/share/php';
\$dolibarr_js_CKEDITOR='disabled';
\$dolibarr_js_JQUERY='/javascript/jquery';
\$dolibarr_js_JQUERY_UI='/javascript/jquery-ui';
\$dolibarr_js_JQUERY_FLOT='/javascript/flot';

\$dolibarr_font_DOL_DEFAULT_TTF='/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf';
\$dolibarr_font_DOL_DEFAULT_TTF_BOLD='/usr/share/fonts/truetype/dejavu/DejaVuSans-Bold.ttf';
?>
" > /etc/dolibarr/conf.php


cd $DL_DIR
$BIN_MYSQL -u root < dolibarr-3.5.4-1.sql mysql

cat << EOT > DOLIBARR_db.sql
GRANT ALL PRIVILEGES ON dolibarr.* TO $MOD_NAME@'localhost' IDENTIFIED BY '$DOLIBARR_MYSQL_PWD';
EOT

$BIN_MYSQL -u root < DOLIBARR_db.sql mysql


}

#_______________________________________________________________________________________________
#________________________________________FIN_INSTALL____________________________________________

#_______________________________________________________________________________________________
#________________________________________CREATE_WUI_____________________________________________

function CREATE_WUI
{

cd /tmp/
./generate_xml_server_desc.php "$LAMPP_DIRECTORY/etc/ciws-content" "$RMOD_NAME" "/dolibarr" "/dolibarr" 

}
#_______________________________________________________________________________________________
#________________________________________FIN_CREATE_WUI_________________________________________


echo "I: Install Dolibarr"
INSTALL
CREATE_WUI
echo "I: End of install Dolibarr"
