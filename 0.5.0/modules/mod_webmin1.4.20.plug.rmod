#!/bin/bash


RMOD_ENGINE=1.0
RMOD_CATEGORY='Software'
RMOD_SUBCATEGORY='Server'
RMOD_NAME='Webmin1.4.20'
RMOD_AUTHOR='Oliv'
RMOD_VERSION=0.2
RMOD_DESCRIPTION='Web based unix management'
RMOD_RUN_IN_CHROOT=True
RMOD_UPDATE_URL='http://cooperation-iws.gensys-net.eu/update/modules/'


WWW_DIRECTORY=$(cat /tmp/web-path)
DL_DIR=$(cat /tmp/web_install-path)
BIN_MYSQL=$(cat /tmp/mysql-path)
LAMPP_DIRECTORY=$WWW_DIRECTORY
DISPLAY=127.0.0.1:5.0
LANG_UI=$(cat /tmp/lang-wui)

#TEMP
MIRROIR=$(cat /tmp/mirroir)
URL_FREE=$(cat /tmp/url_mirroir)
INSTALL=$(cat /tmp/def_install)

#VARIABLES

#_______________________________________________________________________________________________
#__________________________________________LANGFR______________________________________________


function LANGFR

{
MESS_NAME="Entrez le nom de l'installation "
MESS_HOW_MANY="Combien de" 
MESS_DO_YOU_WANT="voulez vous installez ?"
MESS_WARNING_PASSWORD="La prochaine boîte de dialogue va vous demander de saisir le mot de passe root de webmin.
Le mot de passe doit faire plus de six caractères."
}
#_______________________________________________________________________________________________
#__________________________________________FIN_LANGFR___________________________________________

#_______________________________________________________________________________________________
#__________________________________________LANGEN______________________________________________


function LANGEN

{
MESS_NAME="Enter the name of the install "
MESS_HOW_MANY="How many"
MESS_DO_YOU_WANT="do you want to install ?"
MESS_WARNING_PASSWORD="The next dialog box will ask you to choose webmin root password.
the password shall at least count 6 characters."
}
#_______________________________________________________________________________________________
#__________________________________________FIN_LANGEN___________________________________________


#_______________________________________________________________________________________________
#__________________________________________CHOICE_LANG___________________________________________

function CHOICE_LANG
{
if [ "$(echo "${LANG_UI}" | awk  '{print $1}')" == "FR" ]; then
LANGFR

else
LANGEN

fi
}
#_______________________________________________________________________________________________
#__________________________________________FIN_CHOICE_LANG______________________________________


#_______________________________________________________________________________________________
#________________________________________WGET_MIRROIR_WEB_______________________________________


function WGET_MIRROIR_WEB
{
echo -e '\E[37;44m'"\033[1m $MESSAGE \033[0m"
wget http://surfnet.dl.sourceforge.net/sourceforge/webadmin/webmin_1.420_all.deb




}

#_______________________________________________________________________________________________
#________________________________________FIN_WGET_MIRROIR_WEB___________________________________

#_______________________________________________________________________________________________
#________________________________________WGET_MIRROIR_LOCAL_____________________________________

function WGET_MIRROIR_LOCAL
{

cd $DL_DIR
wget http://$MIRROIR_URL/mirroir/webmin_1.410_all.deb



}

#_______________________________________________________________________________________________
#________________________________________FIN_WGET_MIRROIR_LOCAL_________________________________

#_______________________________________________________________________________________________
#________________________________________WGET_MIRROIR_FREE______________________________________

function WGET_MIRROIR_FREE
{
cd $DL_DIR
wget $URL_FREE/webmin_1.420_all.deb




}

#_______________________________________________________________________________________________
#________________________________________FIN_WGET_MIRROIR_FREE__________________________________

#_______________________________________________________________________________________________
#________________________________________DOWNLOAD_______________________________________________

function DOWNLOAD
{
if [ "$(echo "${MIRROIR}" | awk  '{print $1}')" == "A" ]; then 

WGET_MIRROIR_WEB
fi
if  [ "$(echo "${MIRROIR}" | awk  '{print $1}')" == "B" ]; then

WGET_MIRROIR_FREE
fi
if  [ "$(echo "${MIRROIR}" | awk  '{print $1}')" == "C" ]; then


WGET_MIRROIR_LOCAL
fi

}


#_______________________________________________________________________________________________
#________________________________________FIN_DOWNLOAD___________________________________________

#_______________________________________________________________________________________________
#________________________________________INSTALL________________________________________________


function INSTALL
{

echo "
---------COOPERATION LIVE SCRIPTS $VERSION----------

$MESS_WARNING_PASSWORD
" | sudo tee "/tmp/cust_webmin.txt"
zenity \
--title="Live CD/USB" \
--width=640 \
--height=480 \
--text-info \
--editable \
--filename="/tmp/cust_webmin.txt"

function CHOIX_PASS() 
{
SAISIE_PASS1="";SAISIE_PASS2="";

function SAISIE()
{
SAISIE_PASS1=$(zenity --entry --hide-text --text "Saisie du mot de passe utilisateur (1)")
test $? -ne 0 && break && SAISIE_PASS1="" && SAISIE_PASS2="" # Bouton Annuler
sleep 2
SAISIE_PASS2=$(zenity --entry --hide-text --text "Confirmez, Saisie du mot de passe utilisateur (2)")
test $? -ne 0 && break && SAISIE_PASS1="" && SAISIE_PASS2="" # Bouton Annuler
}
while [[ "$SAISIE_PASS1" != "$SAISIE_PASS2" || "$(echo -e "$SAISIE_PASS1" | wc -m)" -le "6" ]]
do
SAISIE
if [[ -n "$SAISIE_PASS1" && -n "$SAISIE_PASS2" ]]; then
if  [ $(echo -e "$SAISIE_PASS1" | wc -m) -le 6 ]; then
echo -e "\033[1;47;31m la saisie minimum est de 6 caractères \033[0m" ;
elif [ "$SAISIE_PASS1" != "$SAISIE_PASS2" ]; then
echo -e "\033[1;47;31m Erreur: pass 1 et 2 differents! \033[0m" ;
fi
fi
done
if [[ "$SAISIE_PASS1" == "$SAISIE_PASS2" && "$(echo -e "$SAISIE_PASS1" | wc -m)" -ge "6" ]]; then

echo $SAISIE_PASS2 > $DOSSIER_CHROOT/tmp/passwd.txt
fi
}

CHOIX_PASS

echo "I: Download Webmin"
DOWNLOAD
DEBIAN_FRONTEND="dialog"
apt-get install --assume-yes --force-yes libnet-ssleay-perl libauthen-pam-perl libio-pty-perl libmd5-perl openssl
#WEBMIN CONFIG


echo "
GREP=$(ps aux | grep 'share/webmin')
PID=$(echo $GREP | cut -d' ' -f2)
kill $PID
killall "/usr/bin/perl /usr/share/webmin/miniserv.pl /etc/webmin/miniserv.conf"
" >> /tmp/shutdown_ws.sh

cd $DL_DIR

GREP=$(ps aux | grep 'share/webmin')
PID=$(echo $GREP | cut -d' ' -f2)
kill $PID
killall "/usr/bin/perl /usr/share/webmin/miniserv.pl /etc/webmin/miniserv.conf"

dpkg -i webmin_1.420_all.deb

/usr/share/webmin/changepass.pl /etc/webmin root $(cat /tmp/passwd.txt)



}

#_______________________________________________________________________________________________
#________________________________________FIN_INSTALL____________________________________________

#_______________________________________________________________________________________________
#________________________________________CREATE_WUI_____________________________________________

function CREATE_WUI
{
echo "<hr width=\"10%\">
$RMOD_DESCRIPTION | <a href=\"https://<?php echo \$HTTP_SERVER_VARS[\"SERVER_NAME\"]?>:10000\">Webmin</a><br>
">> $WWW_DIRECTORY/admin/cooperation-wui.frame.php
}
#_______________________________________________________________________________________________
#________________________________________FIN_CREATE_WUI_________________________________________


echo "I: Install Webmin"
CHOICE_LANG
INSTALL
CREATE_WUI
echo "I: End of install Webmin"
